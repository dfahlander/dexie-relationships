{"version":3,"file":null,"sources":["../src/schema-parser.js","../src/utils.js","../src/index.js"],"sourcesContent":["class SchemaParser {\r\n\r\n  /**\r\n   * Schema parser\r\n   *\r\n   * @param schema\r\n   */\r\n  constructor (schema) {\r\n    this.schema = schema\r\n  }\r\n\r\n  /**\r\n   * Extracts foreign keys from the schema\r\n   *\r\n   * @returns Object\r\n   */\r\n  getForeignKeys () {\r\n    let foreignKeys = {}\r\n\r\n    Object.keys(this.schema).forEach(table => {\r\n      let indexes = this.schema[table].split(',')\r\n\r\n      foreignKeys[table] = indexes\r\n        .filter(idx => idx.indexOf('->') !== -1)\r\n        .map(idx => {\r\n          // split the column and foreign table info\r\n          let [column, target] = idx.split('->').map(x => x.trim())\r\n\r\n          return {\r\n            index: column,\r\n            targetTable: target.split('.')[0],\r\n            targetIndex: target.split('.')[1]\r\n          }\r\n        })\r\n    })\r\n\r\n    return foreignKeys\r\n  }\r\n\r\n  /**\r\n   * Get schema without the foreign key definitions\r\n   *\r\n   * @returns Object\r\n   */\r\n  getCleanedSchema () {\r\n    let schema = {}\r\n\r\n    Object.keys(this.schema).forEach(table => {\r\n      let indexes = this.schema[table].split(',')\r\n\r\n      // Remove foreign keys syntax before calling the original method\r\n      schema[table] = indexes.map(idx => idx.split('->')[0].trim()).join(',')\r\n    })\r\n\r\n    return schema\r\n  }\r\n}\r\n\r\nexport default SchemaParser\r\n","\r\nexport function isIndexableType (value) {\r\n  return value != null && (// Using \"!=\" instead of \"!==\" to check for both null and undefined!\r\n      typeof value === 'string' ||\r\n      typeof value === 'number' ||\r\n      value instanceof Date ||\r\n      (Array.isArray(value) && value.every(isIndexableType))\r\n    )\r\n}\r\n","import Dexie from 'dexie'\r\nimport SchemaParser from './schema-parser'\r\nimport {isIndexableType} from './utils'\r\n\r\nconst Relationships = (db) => {\r\n  // Use Dexie.Promise to ensure transaction safety.\r\n  const Promise = Dexie.Promise\r\n\r\n  /**\r\n   * Iterate through all items and collect related records\r\n   *\r\n   * @param relationships\r\n   *\r\n   * @returns {Dexie.Promise}\r\n   */\r\n  db.Table.prototype.with = function (relationships) {\r\n    return this.toCollection().with(relationships)\r\n  }\r\n\r\n  /**\r\n   * Iterate through all items and collect related records\r\n   *\r\n   * @param relationships\r\n   *\r\n   * @returns {Dexie.Promise}\r\n   */\r\n  db.Collection.prototype.with = function (relationships) {\r\n    const baseTable = this._ctx.table.name\r\n    const databaseTables = db._allTables\r\n\r\n    // this holds tables that have foreign keys pointing at the current table\r\n    let usableForeignTables = []\r\n\r\n    // validate target tables and add them into our usable tables object\r\n    Object.keys(relationships).forEach((column) => {\r\n      let tableOrIndex = relationships[column]\r\n      let matchingIndex = this._ctx.table.schema.idxByName[tableOrIndex]\r\n\r\n      if (matchingIndex && matchingIndex.hasOwnProperty('foreignKey')) {\r\n        let index = matchingIndex\r\n        usableForeignTables.push({\r\n          column: column,\r\n          index: index.foreignKey.targetIndex,\r\n          tableName: index.foreignKey.targetTable,\r\n          targetIndex: index.foreignKey.index,\r\n          oneToOne: true\r\n        })\r\n      } else {\r\n        let table = tableOrIndex\r\n\r\n        if (!databaseTables.hasOwnProperty(table)) {\r\n          throw new Error('Relationship table ' + table + ' doesn\\'t exist.')\r\n        }\r\n\r\n        if (!databaseTables[table].schema.hasOwnProperty('foreignKeys')) {\r\n          throw new Error('Relationship table ' + table + ' doesn\\'t have foreign keys set.')\r\n        }\r\n\r\n        // remove the foreign keys that don't link to the base table\r\n        let columns = databaseTables[table].schema.foreignKeys.filter(column => column.targetTable === baseTable)\r\n\r\n        if (columns.length > 0) {\r\n          usableForeignTables.push({\r\n            column: column,\r\n            index: columns[0].index,\r\n            tableName: table,\r\n            targetIndex: columns[0].targetIndex\r\n          })\r\n        }\r\n      }\r\n    })\r\n\r\n    return this.toArray().then(rows => {\r\n      //\r\n      // Extract the mix of all related keys in all rows\r\n      //\r\n      let queries = usableForeignTables\r\n        .map(foreignTable => {\r\n          // For each foreign table, query all items that any row refers to\r\n          let tableName = foreignTable.tableName\r\n          let allRelatedKeys = rows\r\n            .map(row => row[foreignTable.targetIndex])\r\n            .filter(isIndexableType)\r\n\r\n          // Build the Collection to retrieve all related items\r\n          return databaseTables[tableName]\r\n              .where(foreignTable.index)\r\n              .anyOf(allRelatedKeys)\r\n        })\r\n\r\n      // Execute queries in parallell\r\n      let queryPromises = queries.map(query => query.toArray())\r\n\r\n      //\r\n      // Await all results and then try mapping each response\r\n      // with its corresponding row and attach related items onto each row\r\n      //\r\n      return Promise.all(queryPromises).then(queryResults => {\r\n        usableForeignTables.forEach((foreignTable, idx) => {\r\n          let tableName = foreignTable.tableName\r\n          let result = queryResults[idx]\r\n          let targetIndex = foreignTable.targetIndex\r\n          let foreignIndex = foreignTable.index\r\n          let column = foreignTable.column\r\n\r\n          // Create a lookup by targetIndex (normally 'id')\r\n          // and set the column onto the target\r\n          let lookup = {}\r\n          result.forEach(record => {\r\n            let foreignKey = record[foreignIndex]\r\n            if (foreignTable.oneToOne) {\r\n              lookup[foreignKey] = record\r\n            } else {\r\n              (lookup[foreignKey] = lookup[foreignKey] || [])\r\n                .push(record)\r\n            }\r\n          })\r\n\r\n          // Populate column on each row\r\n          rows.forEach(row => {\r\n            let foreignKey = row[targetIndex]\r\n            let record = lookup[foreignKey]\r\n            if (!record) {\r\n              throw new Error(\r\n                `Could not lookup foreign key where ` +\r\n                `${tableName}.${foreignIndex} == ${baseTable}.${column}. ` +\r\n                `The content of the failing key was: ${JSON.stringify(foreignKey)}.`)\r\n            }\r\n\r\n            // Set it as a non-enumerable property so that the object can be safely put back\r\n            // to indexeddb without storing relations redundantly (IndexedDB will only store \"own non-\r\n            // enumerable properties\")\r\n            Object.defineProperty(row, column, {\r\n              value: record,\r\n              enumerable: false,\r\n              configurable: true,\r\n              writable: true\r\n            })\r\n          })\r\n        })\r\n      }).then(() => rows)\r\n    })\r\n  }\r\n\r\n  db.Version.prototype._parseStoresSpec = Dexie.override(\r\n    db.Version.prototype._parseStoresSpec,\r\n    parseStoresSpec => function (storesSpec, outDbSchema) {\r\n      const parser = new SchemaParser(storesSpec)\r\n\r\n      let foreignKeys = parser.getForeignKeys()\r\n      // call the original method\r\n      let rv = parseStoresSpec.call(this, parser.getCleanedSchema(), outDbSchema)\r\n\r\n      // set foreign keys into database table objects\r\n      // to use later in 'with' method\r\n      Object.keys(outDbSchema).forEach(table => {\r\n        if (foreignKeys.hasOwnProperty(table)) {\r\n          outDbSchema[table].foreignKeys = foreignKeys[table]\r\n          foreignKeys[table].forEach(fk => {\r\n            outDbSchema[table].idxByName[fk.index].foreignKey = fk\r\n          })\r\n        }\r\n      })\r\n\r\n      return rv\r\n    })\r\n}\r\n\r\nexport default Relationships\r\n"],"names":["this","const","let"],"mappings":"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"}